{% extends "base.html" %}

{% block title %}Batch #{{ batch.id }} - Sistema Jur√≠dico{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Card de Status do Batch -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-gradient text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-layer-group me-2"></i>
                    Batch #{{ batch.id }}
                </h4>
                <span class="badge bg-light text-dark">
                    <span id="batch-status">{{ batch.status }}</span>
                </span>
            </div>
            <div class="card-body">
                <!-- Progresso Geral -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <h6 class="text-muted mb-2">Progresso Geral</h6>
                        <div class="progress" style="height: 30px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%">
                                <span id="progress-text">0%</span>
                            </div>
                        </div>
                        <small class="text-muted">
                            <span id="progress-count">0</span>/<span id="total-count">{{ batch.total_count }}</span> processos
                        </small>
                    </div>
                    <div class="col-md-4 text-end">
                        <div id="batch-action-buttons">
                            {% if batch.status in ['ready', 'partial_ready'] %}
                            <button id="btn-start" class="btn btn-success btn-lg" onclick="startBatch()">
                                <i class="fas fa-play me-2"></i>
                                Iniciar Processamento RPA
                            </button>
                            {% elif batch.status == 'running' %}
                            <button id="btn-start" class="btn btn-primary btn-lg" disabled>
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Processando...
                            </button>
                            {% elif batch.status in ['completed', 'partial_completed'] %}
                            <button id="btn-start" class="btn btn-success btn-lg" disabled>
                                <i class="fas fa-check-circle me-2"></i>
                                Completo
                            </button>
                            {% endif %}
                        </div>
                        
                        <!-- Bot√£o Reprocessar (mostra quando h√° itens pendentes, erro ou sem process_id) -->
                        {% set has_pending = items|selectattr('status', 'equalto', 'pending')|list|length > 0 %}
                        {% set has_errors = items|selectattr('status', 'equalto', 'error')|list|length > 0 %}
                        {% set has_ready_no_process = items|selectattr('status', 'equalto', 'ready')|selectattr('process_id', 'none')|list|length > 0 %}
                        {% if has_pending or has_errors or has_ready_no_process or batch.status in ['error', 'running', 'pending'] %}
                        <form action="{{ url_for('batch.batch_reprocess', id=batch.id) }}" method="POST" class="d-inline ms-2">
                            <button type="submit" class="btn btn-warning btn-lg" onclick="return confirm('Deseja reprocessar os itens pendentes/erro?');">
                                <i class="fas fa-redo me-2"></i>
                                Reprocessar
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>

                <!-- Informa√ß√µes do Batch -->
                <div class="row text-center border-top pt-3">
                    <div class="col-md-3">
                        <div class="metric">
                            <i class="fas fa-calendar-alt text-primary fa-2x mb-2"></i>
                            <h6 class="text-muted">Criado em</h6>
                            <p class="mb-0">{{ batch.created_at.strftime('%d/%m/%Y %H:%M') if batch.created_at else '-' }}</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric">
                            <i class="fas fa-play-circle text-info fa-2x mb-2"></i>
                            <h6 class="text-muted">Iniciado em</h6>
                            <p class="mb-0" id="started-at">{{ batch.started_at.strftime('%d/%m/%Y %H:%M') if batch.started_at else '-' }}</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric">
                            <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                            <h6 class="text-muted">Finalizado em</h6>
                            <p class="mb-0" id="finished-at">{{ batch.finished_at.strftime('%d/%m/%Y %H:%M') if batch.finished_at else '-' }}</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric">
                            <i class="fas fa-file-pdf text-danger fa-2x mb-2"></i>
                            <h6 class="text-muted">Total de PDFs</h6>
                            <p class="mb-0">{{ batch.total_count }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Items -->
        <div class="card shadow-lg">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Arquivos do Batch
                </h5>
                <!-- Barra de A√ß√µes em Lote -->
                <div id="bulk-actions" class="d-flex align-items-center gap-2" style="display: none !important;">
                    <span class="text-muted me-2">
                        <span id="selected-count">0</span> selecionado(s)
                    </span>
                    <form id="bulk-extract-form" action="{{ url_for('batch.batch_reextract', id=batch.id) }}" method="POST" class="d-inline">
                        <input type="hidden" name="item_ids" id="bulk-extract-ids">
                        <button type="submit" class="btn btn-warning btn-sm" onclick="return confirmBulkAction('Reprocessar extra√ß√£o dos itens selecionados?')">
                            <i class="fas fa-sync-alt me-1"></i>Reprocessar Extra√ß√£o
                        </button>
                    </form>
                    <form id="bulk-rpa-form" action="{{ url_for('batch.batch_rerpa', id=batch.id) }}" method="POST" class="d-inline">
                        <input type="hidden" name="item_ids" id="bulk-rpa-ids">
                        <button type="submit" class="btn btn-info btn-sm" onclick="return confirmBulkAction('Reprocessar RPA dos itens selecionados?')">
                            <i class="fas fa-robot me-1"></i>Reprocessar RPA
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="items-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="select-all" class="form-check-input" title="Selecionar Todos">
                                </th>
                                <th>#</th>
                                <th>Arquivo</th>
                                <th>Status</th>
                                <th>Status RPA</th>
                                <th>Processo</th>
                                <th>Tentativas</th>
                                <th>Erro</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr data-item-id="{{ item.id }}">
                                <td>
                                    <input type="checkbox" class="form-check-input item-checkbox" 
                                           value="{{ item.id }}" data-item-id="{{ item.id }}">
                                </td>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <i class="fas fa-file-pdf text-danger me-2"></i>
                                    {{ item.source_filename }}
                                    {% if item.file_size %}
                                    <small class="text-muted">({{ (item.file_size / 1024 / 1024)|round(1) }}MB)</small>
                                    {% endif %}
                                </td>
                                <td class="status-cell">
                                    {% if item.status == 'success' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Sucesso
                                        </span>
                                    {% elif item.status == 'running' %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-spinner fa-spin me-1"></i>Executando
                                        </span>
                                    {% elif item.status == 'ready' %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-clock me-1"></i>Pronto
                                        </span>
                                    {% elif item.status == 'extracting' %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-cog fa-spin me-1"></i>Extraindo
                                        </span>
                                    {% elif item.status == 'error' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Erro
                                        </span>
                                    {% elif item.status == 'pending' %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-hourglass-start me-1"></i>Pendente
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ item.status }}</span>
                                    {% endif %}
                                </td>
                                <td class="rpa-status-cell" data-process-id="{{ item.process_id if item.process_id else '' }}">
                                    {% if item.process and item.process.elaw_status == 'running' %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-spinner fa-pulse me-1"></i><span class="rpa-status-text">Iniciando...</span>
                                        </span>
                                    {% elif item.process and item.process.elaw_status == 'success' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Conclu√≠do
                                        </span>
                                    {% elif item.process and item.process.elaw_status == 'error' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times me-1"></i>Erro
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="process-cell">
                                    {% if item.process_id %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Processo #{{ item.process_id }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="attempts-cell">{{ item.attempt_count }}</td>
                                <td class="error-cell">
                                    {% if item.last_error %}
                                        <button class="btn btn-sm btn-outline-danger" 
                                                data-bs-toggle="tooltip" 
                                                title="{{ item.last_error }}">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="actions-cell" data-item-id="{{ item.id }}" data-process-id="{{ item.process_id if item.process_id else '' }}">
                                    <div class="btn-group" role="group">
                                        {% if item.process_id %}
                                        {% if item.process and item.process.elaw_status == 'running' %}
                                        <a href="{{ url_for('core.rpa_progress', process_id=item.process_id, batch_id=batch.id) }}" 
                                           class="btn btn-sm btn-info" 
                                           data-bs-toggle="tooltip" title="Ver Progresso RPA">
                                            <i class="fas fa-spinner fa-pulse"></i>
                                        </a>
                                        {% else %}
                                        {% set missing_fields = item.process.get_missing_critical_fields() if item.process else [] %}
                                        {% set has_missing = missing_fields|length > 0 %}
                                        <a href="{{ url_for('core.process_view', id=item.process_id, batch_id=batch.id) }}" 
                                           class="btn btn-sm {% if has_missing %}btn-danger{% else %}btn-outline-primary{% endif %}" 
                                           data-bs-toggle="tooltip" title="{% if has_missing %}Campos faltando: {{ missing_fields|join(', ') }}{% else %}Visualizar processo{% endif %}"
                                           id="view-btn-{{ item.process_id }}">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% endif %}
                                        <a href="{{ url_for('core.process_edit', id=item.process_id, batch_id=batch.id) }}" 
                                           class="btn btn-sm btn-outline-secondary" 
                                           data-bs-toggle="tooltip" title="Editar processo">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                        <a href="{{ url_for('batch.batch_item_pdf', id=item.id) }}" 
                                           class="btn btn-sm btn-outline-info" 
                                           data-bs-toggle="tooltip" title="Ver PDF original" target="_blank">
                                            <i class="fas fa-file-pdf"></i>
                                        </a>
                                        {% if item.process and item.process.elaw_screenshot_before_path %}
                                        <a href="{{ url_for('core.serve_rpa_screenshot', filename=item.process.elaw_screenshot_before_path) }}" 
                                           class="btn btn-sm btn-outline-success" 
                                           data-bs-toggle="tooltip" title="Screenshot ANTES de salvar" target="_blank">
                                            <i class="fas fa-camera"></i>
                                        </a>
                                        {% endif %}
                                        {% if item.process and item.process.elaw_screenshot_after_path %}
                                        <a href="{{ url_for('core.serve_rpa_screenshot', filename=item.process.elaw_screenshot_after_path) }}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           data-bs-toggle="tooltip" title="Screenshot DEPOIS de salvar" target="_blank">
                                            <i class="fas fa-camera-retro"></i>
                                        </a>
                                        {% endif %}
                                        {% if item.process and item.process.elaw_screenshot_reclamadas_path %}
                                        <a href="{{ url_for('core.serve_rpa_screenshot', filename=item.process.elaw_screenshot_reclamadas_path) }}" 
                                           class="btn btn-sm btn-outline-warning" 
                                           data-bs-toggle="tooltip" title="Screenshot RECLAMADAS" target="_blank">
                                            <i class="fas fa-users"></i>
                                        </a>
                                        {% endif %}
                                        {% if item.process and item.process.elaw_screenshot_pedidos_path %}
                                        <a href="{{ url_for('core.serve_rpa_screenshot', filename=item.process.elaw_screenshot_pedidos_path) }}" 
                                           class="btn btn-sm btn-outline-info" 
                                           data-bs-toggle="tooltip" title="Screenshot PEDIDOS" target="_blank">
                                            <i class="fas fa-list-alt"></i>
                                        </a>
                                        {% endif %}
                                        {% if item.status in ['error', 'ready'] and item.process_id %}
                                        <form action="{{ url_for('batch.batch_item_retry', id=item.id) }}" 
                                              method="POST" style="display:inline;">
                                            <button type="submit" class="btn btn-sm btn-warning" 
                                                    data-bs-toggle="tooltip" title="Reprocessar RPA">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                        <form action="{{ url_for('batch.batch_item_delete', id=item.id) }}" 
                                              method="POST" style="display:inline;" 
                                              onsubmit="return confirm('Tem certeza que deseja deletar este item?');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                    data-bs-toggle="tooltip" title="Deletar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <a href="{{ url_for('batch.batch_list') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Voltar para Lista
            </a>
            <span id="final-buttons-container">
                {% if batch.status in ['completed', 'partial_completed'] %}
                <a href="{{ url_for('core.dashboard') }}" class="btn btn-success ms-2">
                    <i class="fas fa-home me-2"></i>Voltar para Dashboard
                </a>
                <a href="{{ url_for('batch.batch_new') }}" class="btn btn-primary ms-2">
                    <i class="fas fa-plus me-2"></i>Iniciar Outro Batch
                </a>
                {% endif %}
            </span>
        </div>
    </div>
</div>

<script>
let pollingInterval = null;
const POLL_INTERVAL = 1000; // 1 segundo - tempo real para acompanhar cada etapa
const batchId = {{ batch.id }};
let completionToastShown = false; // Flag para evitar toasts repetidos
const initialBatchStatus = '{{ batch.status }}'; // Status inicial ao carregar a p√°gina

async function startBatch() {
    const btn = document.getElementById('btn-start');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Iniciando...';
    
    try {
        const response = await fetch(`/processos/batch/${batchId}/start`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            startPolling();
        } else {
            showToast('Erro: ' + (data.error || 'Falha ao iniciar processamento'), 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play me-2"></i>Iniciar Processamento RPA';
        }
    } catch (error) {
        console.error('Erro ao iniciar batch:', error);
        showToast('Erro de conex√£o. Tente novamente.', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play me-2"></i>Iniciar Processamento RPA';
    }
}

async function updateBatchStatus() {
    try {
        const response = await fetch(`/processos/batch/${batchId}/status`);
        const data = await response.json();
        
        // Atualizar progresso
        const percent = data.progress_percent || 0;
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('progress-text').textContent = percent + '%';
        document.getElementById('progress-count').textContent = data.processed_count;
        document.getElementById('total-count').textContent = data.total_count;
        document.getElementById('batch-status').textContent = data.status;
        
        // Atualizar timestamps
        if (data.started_at) {
            document.getElementById('started-at').textContent = new Date(data.started_at).toLocaleString('pt-BR');
        }
        if (data.finished_at) {
            document.getElementById('finished-at').textContent = new Date(data.finished_at).toLocaleString('pt-BR');
        }
        
        // Atualizar items
        data.items.forEach(item => {
            const row = document.querySelector(`tr[data-item-id="${item.id}"]`);
            if (row) {
                updateItemRow(row, item);
            }
        });
        
        // Atualizar status RPA para processos em execu√ß√£o
        await updateRPAStatuses();
        
        // Parar polling se conclu√≠do
        if (['completed', 'partial_completed'].includes(data.status)) {
            stopPolling();
            document.getElementById('progress-bar').classList.remove('progress-bar-animated');
            document.getElementById('progress-bar').classList.add('bg-success');
            
            // Atualizar bot√£o para "Completo"
            const btnStart = document.getElementById('btn-start');
            if (btnStart) {
                btnStart.innerHTML = '<i class="fas fa-check-circle me-2"></i>Completo';
                btnStart.className = 'btn btn-success btn-lg';
                btnStart.disabled = true;
            }
            
            // MOSTRAR BOT√ïES FINAIS AUTOMATICAMENTE
            const finalButtonsContainer = document.getElementById('final-buttons-container');
            if (finalButtonsContainer) {
                finalButtonsContainer.innerHTML = `
                    <a href="/dashboard" class="btn btn-success ms-2">
                        <i class="fas fa-home me-2"></i>Voltar para Dashboard
                    </a>
                    <a href="/processos/batch/new" class="btn btn-primary ms-2">
                        <i class="fas fa-plus me-2"></i>Iniciar Outro Batch
                    </a>
                `;
            }
            
            // Calcular estat√≠sticas e mostrar toast APENAS UMA VEZ
            // Evitar spam de toasts: s√≥ mostrar se n√£o foi mostrado antes E se o status mudou
            // (n√£o mostrar se o batch j√° estava conclu√≠do quando a p√°gina carregou)
            if (!completionToastShown && !['completed', 'partial_completed'].includes(initialBatchStatus)) {
                completionToastShown = true; // Marcar como mostrado
                
                const successCount = data.items.filter(item => item.status === 'success').length;
                const totalCount = data.items.length;
                
                if (data.status === 'completed') {
                    showToast(`Batch RPA conclu√≠do! ${successCount}/${totalCount} processos preenchidos com sucesso no eLaw.`, 'success');
                } else {
                    const errorCount = totalCount - successCount;
                    showToast(`Batch RPA conclu√≠do parcialmente. ${successCount} sucesso(s), ${errorCount} erro(s). Verifique os detalhes abaixo.`, 'warning');
                }
            }
        }
        
    } catch (error) {
        console.error('Erro ao atualizar status:', error);
    }
}

async function updateRPAStatuses() {
    // Buscar todas as c√©lulas com process_id
    const rpaCells = document.querySelectorAll('.rpa-status-cell[data-process-id]');
    
    for (const cell of rpaCells) {
        const processId = cell.getAttribute('data-process-id');
        if (!processId) continue;
        
        try {
            const response = await fetch(`/api/rpa-status/${processId}`);
            const rpaStatus = await response.json();
            
            // PRIORIZAR status 'completed'/'success' PRIMEIRO
            if (rpaStatus.status === 'completed' || rpaStatus.status === 'success') {
                // Check verde para processos conclu√≠dos
                cell.innerHTML = `
                    <span class="badge bg-success">
                        <i class="fas fa-check me-1"></i>Conclu√≠do
                    </span>
                `;
            } else if (rpaStatus.status === 'error') {
                cell.innerHTML = `
                    <span class="badge bg-danger">
                        <i class="fas fa-times me-1"></i>Erro
                    </span>
                `;
            } else if (rpaStatus.status === 'running' || rpaStatus.current_step) {
                const message = rpaStatus.message || rpaStatus.current_step || 'Processando...';
                cell.innerHTML = `
                    <span class="badge bg-info">
                        <i class="fas fa-spinner fa-pulse me-1"></i>${message}
                    </span>
                `;
            }
        } catch (error) {
            // Silenciar erros (processo pode n√£o ter RPA ativo)
        }
    }
}

async function updateItemRow(row, item) {
    const statusCell = row.querySelector('.status-cell');
    const processCell = row.querySelector('.process-cell');
    const attemptsCell = row.querySelector('.attempts-cell');
    const errorCell = row.querySelector('.error-cell');
    const actionsCell = row.querySelector('.actions-cell');
    
    // Status badge
    const statusIcons = {
        'success': '<i class="fas fa-check-circle me-1"></i>Sucesso',
        'running': '<i class="fas fa-spinner fa-spin me-1"></i>Executando',
        'ready': '<i class="fas fa-clock me-1"></i>Pronto',
        'extracting': '<i class="fas fa-cog fa-spin me-1"></i>Extraindo',
        'error': '<i class="fas fa-exclamation-triangle me-1"></i>Erro',
        'pending': '<i class="fas fa-hourglass-start me-1"></i>Pendente'
    };
    
    const statusClasses = {
        'success': 'bg-success',
        'running': 'bg-primary',
        'ready': 'bg-info',
        'extracting': 'bg-warning',
        'error': 'bg-danger',
        'pending': 'bg-secondary'
    };
    
    statusCell.innerHTML = `<span class="badge ${statusClasses[item.status] || 'bg-secondary'}">${statusIcons[item.status] || item.status}</span>`;
    
    // Process link
    if (item.process_id) {
        processCell.innerHTML = `<a href="/processos/${item.process_id}" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye me-1"></i>Ver #${item.process_id}</a>`;
    }
    
    // Attempts
    attemptsCell.textContent = item.attempt_count;
    
    // Error
    if (item.last_error) {
        errorCell.innerHTML = `<button class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="${item.last_error}"><i class="fas fa-info-circle"></i></button>`;
        // Inicializar tooltip do bot√£o de erro com fun√ß√£o centralizada
        initTooltips(errorCell);
    }
    
    // NOVA FUN√á√ÉO: Atualizar coluna A√ß√µes com screenshots em tempo real
    if (actionsCell && item.process_id) {
        await updateActionsCell(actionsCell, item);
    }
}

async function updateActionsCell(actionsCell, item) {
    const processId = item.process_id;
    const itemId = item.id;
    
    // N√£o atualizar se n√£o houver process_id
    if (!processId) {
        return;
    }
    
    try {
        // üîß FIX: Usar dados do processo que j√° v√™m na API batch/status
        // ao inv√©s de fazer outro fetch desnecess√°rio
        const processData = item.process || {};
        
        // Construir HTML dos bot√µes
        let buttonsHTML = '<div class="btn-group" role="group">';
        
        // Bot√£o Ver/Progresso RPA
        if (processData.elaw_status === 'running') {
            buttonsHTML += `
                <a href="/processos/rpa/progress/${processId}?batch_id=${batchId}" 
                   class="btn btn-sm btn-info" 
                   data-bs-toggle="tooltip" title="Ver Progresso RPA">
                    <i class="fas fa-spinner fa-pulse"></i>
                </a>
            `;
        } else {
            buttonsHTML += `
                <a href="/processos/${processId}?batch_id=${batchId}" 
                   class="btn btn-sm btn-outline-primary" 
                   data-bs-toggle="tooltip" title="Visualizar processo">
                    <i class="fas fa-eye"></i>
                </a>
            `;
        }
        
        // Bot√£o Editar
        buttonsHTML += `
            <a href="/processos/${processId}/edit?batch_id=${batchId}" 
               class="btn btn-sm btn-outline-secondary" 
               data-bs-toggle="tooltip" title="Editar processo">
                <i class="fas fa-edit"></i>
            </a>
        `;
        
        // Bot√£o PDF
        buttonsHTML += `
            <a href="/processos/batch/item/${itemId}/pdf" 
               class="btn btn-sm btn-outline-info" 
               data-bs-toggle="tooltip" title="Ver PDF original" target="_blank">
                <i class="fas fa-file-pdf"></i>
            </a>
        `;
        
        // Bot√£o Screenshot ANTES (aparece se existir)
        if (processData.elaw_screenshot_before_path) {
            // üîß FIX: Usar rota /rpa_screenshots/ em vez de /static/
            buttonsHTML += `
                <a href="/rpa_screenshots/${processData.elaw_screenshot_before_path}" 
                   class="btn btn-sm btn-outline-success" 
                   data-bs-toggle="tooltip" title="Screenshot ANTES de salvar" target="_blank">
                    <i class="fas fa-camera"></i>
                </a>
            `;
        }
        
        // Bot√£o Screenshot DEPOIS (aparece se existir)
        if (processData.elaw_screenshot_after_path) {
            // üîß FIX: Usar rota /rpa_screenshots/ em vez de /static/
            buttonsHTML += `
                <a href="/rpa_screenshots/${processData.elaw_screenshot_after_path}" 
                   class="btn btn-sm btn-outline-primary" 
                   data-bs-toggle="tooltip" title="Screenshot DEPOIS de salvar" target="_blank">
                    <i class="fas fa-camera-retro"></i>
                </a>
            `;
        }
        
        // Bot√£o Screenshot RECLAMADAS (aparece se existir)
        if (processData.elaw_screenshot_reclamadas_path) {
            buttonsHTML += `
                <a href="/rpa_screenshots/${processData.elaw_screenshot_reclamadas_path}" 
                   class="btn btn-sm btn-outline-warning" 
                   data-bs-toggle="tooltip" title="Screenshot RECLAMADAS" target="_blank">
                    <i class="fas fa-users"></i>
                </a>
            `;
        }
        
        // Bot√£o Screenshot PEDIDOS (aparece se existir)
        if (processData.elaw_screenshot_pedidos_path) {
            buttonsHTML += `
                <a href="/rpa_screenshots/${processData.elaw_screenshot_pedidos_path}" 
                   class="btn btn-sm btn-outline-info" 
                   data-bs-toggle="tooltip" title="Screenshot PEDIDOS" target="_blank">
                    <i class="fas fa-list-alt"></i>
                </a>
            `;
        }
        
        // Bot√£o Reprocessar (s√≥ se erro)
        if (item.status === 'error') {
            buttonsHTML += `
                <form action="/processos/batch/item/${itemId}/retry" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-warning" 
                            data-bs-toggle="tooltip" title="Reprocessar">
                        <i class="fas fa-redo"></i>
                    </button>
                </form>
            `;
        }
        
        // Bot√£o Deletar
        buttonsHTML += `
            <form action="/processos/batch/item/${itemId}/delete" method="POST" style="display:inline;" 
                  onsubmit="return confirm('Tem certeza que deseja deletar este item?');">
                <button type="submit" class="btn btn-sm btn-outline-danger" 
                        data-bs-toggle="tooltip" title="Deletar">
                    <i class="fas fa-trash"></i>
                </button>
            </form>
        `;
        
        buttonsHTML += '</div>';
        
        // Atualizar HTML da c√©lula
        actionsCell.innerHTML = buttonsHTML;
        
        // Reinicializar tooltips com fun√ß√£o centralizada
        initTooltips(actionsCell);
        
    } catch (error) {
        console.error('Erro ao atualizar a√ß√µes:', error);
    }
}

function startPolling() {
    if (!pollingInterval) {
        pollingInterval = setInterval(updateBatchStatus, POLL_INTERVAL);
    }
}

function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

// Fun√ß√£o para inicializar tooltips com configura√ß√£o correta
function initTooltips(container = document) {
    const tooltipTriggerList = container.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(el => {
        // Destruir tooltip existente se houver
        const existingTooltip = bootstrap.Tooltip.getInstance(el);
        if (existingTooltip) {
            existingTooltip.dispose();
        }
        // Criar novo tooltip com trigger expl√≠cito
        new bootstrap.Tooltip(el, {
            trigger: 'hover',
            delay: { show: 200, hide: 0 }
        });
    });
}

// Inicializar tooltips existentes ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', async function() {
    initTooltips();
    
    // üîß FIX: For√ßar atualiza√ß√£o de TODOS os bot√µes de a√ß√£o ao carregar a p√°gina
    // Isso garante que screenshots apare√ßam mesmo se o polling j√° tiver parado
    const allRows = document.querySelectorAll('tr[data-item-id]');
    for (const row of allRows) {
        const actionsCell = row.querySelector('.actions-cell');
        const processId = row.querySelector('.process-cell a')?.href?.match(/\/processos\/(\d+)/)?.[1];
        
        if (actionsCell && processId) {
            await updateActionsCell(actionsCell, { 
                id: row.getAttribute('data-item-id'),
                process_id: parseInt(processId),
                status: row.querySelector('.status-cell .badge')?.textContent?.toLowerCase().includes('sucesso') ? 'success' : 'unknown'
            });
        }
    }
});

// Iniciar polling se batch est√° em execu√ß√£o
{% if batch.status in ['running', 'extracting', 'queued'] %}
startPolling();
{% endif %}

// üîß FIX: Tamb√©m iniciar polling se batch est√° "completed" mas h√° processos success sem screenshots
// Isso garante que os bot√µes apare√ßam mesmo se a p√°gina for recarregada ap√≥s o batch terminar
{% if batch.status in ['completed', 'partial_completed'] %}
(async function() {
    // Aguardar 2 segundos e verificar se h√° processos success sem screenshots
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    const successRows = document.querySelectorAll('tr[data-item-id]');
    let needsUpdate = false;
    
    for (const row of successRows) {
        const statusBadge = row.querySelector('.status-cell .badge');
        const actionsCell = row.querySelector('.actions-cell');
        
        if (statusBadge?.textContent?.toLowerCase().includes('sucesso')) {
            // Verificar se tem bot√µes de screenshot
            const hasScreenshotButtons = actionsCell?.querySelector('a[title*="Screenshot"]');
            if (!hasScreenshotButtons) {
                needsUpdate = true;
                break;
            }
        }
    }
    
    // Se encontrou processos success sem screenshots, iniciar polling por mais 30 segundos
    if (needsUpdate) {
        console.log('[BATCH] Detectados processos success sem screenshots - iniciando polling adicional');
        startPolling();
        setTimeout(stopPolling, 30000); // Parar ap√≥s 30 segundos
    }
})();
{% endif %}

// Cleanup ao sair da p√°gina
window.addEventListener('beforeunload', stopPolling);

// ========== SISTEMA DE SELE√á√ÉO EM LOTE ==========
const selectAllCheckbox = document.getElementById('select-all');
const itemCheckboxes = document.querySelectorAll('.item-checkbox');
const bulkActions = document.getElementById('bulk-actions');
const selectedCountEl = document.getElementById('selected-count');
const bulkExtractIds = document.getElementById('bulk-extract-ids');
const bulkRpaIds = document.getElementById('bulk-rpa-ids');

function updateBulkActions() {
    const selectedItems = document.querySelectorAll('.item-checkbox:checked');
    const count = selectedItems.length;
    
    selectedCountEl.textContent = count;
    
    // Mostrar/ocultar barra de a√ß√µes
    if (count > 0) {
        bulkActions.style.cssText = 'display: flex !important;';
    } else {
        bulkActions.style.cssText = 'display: none !important;';
    }
    
    // Atualizar campos hidden com IDs selecionados
    const ids = Array.from(selectedItems).map(cb => cb.value).join(',');
    bulkExtractIds.value = ids;
    bulkRpaIds.value = ids;
    
    // Atualizar estado do "Selecionar Todos"
    if (count === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (count === itemCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// Event: Selecionar Todos
selectAllCheckbox.addEventListener('change', function() {
    itemCheckboxes.forEach(cb => {
        cb.checked = this.checked;
    });
    updateBulkActions();
});

// Event: Checkbox individual
itemCheckboxes.forEach(cb => {
    cb.addEventListener('change', updateBulkActions);
});

// Confirmar a√ß√£o em lote
function confirmBulkAction(message) {
    const selectedItems = document.querySelectorAll('.item-checkbox:checked');
    if (selectedItems.length === 0) {
        alert('Selecione pelo menos um item.');
        return false;
    }
    return confirm(message);
}

// Inicializar estado
updateBulkActions();
</script>

<style>
.bg-gradient {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
}

.metric {
    padding: 15px;
}

.progress {
    border-radius: 10px;
}

.progress-bar {
    transition: width 0.5s ease;
}
</style>
{% endblock %}
